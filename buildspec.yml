version: 0.2
env:
  variables:
    CUDA_HOME: "/usr/local/cuda"
phases:
  install:
    runtime-versions:
      python: 3.10
    commands:
      - echo "ğŸ”§ Updating system packages and installing CMake..."
      - apt-get update && apt-get install -y cmake
      - echo "âœ… System packages updated and CMake installed"

  pre_build:
    commands:
      - echo "ğŸ” Capturing triggering commit SHA..."
      - TRIGGER_COMMIT_SHA=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION)
      - echo "Triggered by commit: $TRIGGER_COMMIT_SHA"

  build:
    commands:
      - echo "ğŸ Installing Python dependencies..."
      - pip install --upgrade pip
      - echo "âœ… Pip upgraded successfully"

      - echo "ğŸ”¥ Installing PyTorch with CUDA support..."
      - pip uninstall -y torch
      - pip cache purge
      - pip install torch --index-url https://download.pytorch.org/whl/cu118
      - echo "âœ… PyTorch installed successfully"

      - echo "ğŸ¦™ Installing llama-cpp-python with CUDA support..."
      - pip uninstall -y llama-cpp-python
      - pip cache remove llama_cpp_python
      - CMAKE_ARGS="-DLLAMA_CUBLAS=on" FORCE_CMAKE=1 pip install llama-cpp-python==0.2.75 --no-cache-dir
      - echo "âœ… llama-cpp-python installed successfully"

      - echo "ğŸ¤— Installing huggingface_hub, transformers, bitsandbytes, and accelerate..."
      - pip install huggingface_hub transformers
      - pip install bitsandbytes --prefer-binary
      - pip install accelerate
      - echo "âœ… huggingface_hub, transformers, bitsandbytes, and accelerate installed successfully"

      - echo "ğŸ”§ Installing InstructLab..."
      - pip install instructlab --no-cache-dir
      - echo "âœ… InstructLab installed successfully"

      - echo "ğŸ” Checking GPU acceleration support..."
      - |
        python -c '
        import llama_cpp
        is_supported = llama_cpp.llama_supports_gpu_offload()
        print("ğŸ–¥ï¸ Is GPU acceleration supported: " + str(is_supported))
        '

      - echo "ğŸ“‚ Cloning repositories at specific commit..."
      - git clone https://github.com/nicklamb97/generated.git
      - cd generated && git checkout $TRIGGER_COMMIT_SHA && cd ..
      - git clone https://github.com/nicklamb97/instructlab-config.git
      - echo "âœ… Repositories cloned successfully"

      - echo "ğŸ“„ Copying config file..."
      - cp instructlab-config/config.yaml .
      - echo "âœ… Config file copied successfully"

      - echo "ğŸ“¥ Downloading pre-trained model..."
      - ilab model download --repository=NickLamb/OpenROAD-8B-Instruct --filename=OpenROAD-8B-Instruct.Q4_K_M.gguf
      - echo "âœ… Pre-trained model downloaded successfully"

      - echo "ğŸ‹ï¸ Training model with 4-bit quantization..."
      - ilab model train --device=cuda --num-epochs 20 --4-bit-quant
      - echo "âœ… Model training completed"

      - echo "ğŸ·ï¸ Renaming models..."
      - |
        python -c '
        import os
        from datetime import datetime
        import shutil
        current_time = datetime.now().strftime("%Y%m%d_%H%M%S")
        models_dir = "models"
        models_old_dir = "models_old"
        os.makedirs(models_old_dir, exist_ok=True)
        old_model_path = os.path.join(models_dir, "OpenROAD-8B-Instruct.Q4_K_M.gguf")
        if os.path.exists(old_model_path):
            old_model_name = f"openroad-model-{current_time}.gguf"
            shutil.move(old_model_path, os.path.join(models_old_dir, old_model_name))
            print(f"ğŸ“¦ Moved old OpenROAD-8B-Instruct.Q4_K_M.gguf to {models_old_dir}/{old_model_name}")
        else:
            print("No existing OpenROAD-8B-Instruct.Q4_K_M.gguf found")
        new_model_path = os.path.join(models_dir, "ggml-model-f16.gguf")
        if os.path.exists(new_model_path):
            os.rename(new_model_path, os.path.join(models_dir, "OpenROAD-8B-Instruct.Q4_K_M.gguf"))
            print("âœ… Renamed ggml-model-f16.gguf to OpenROAD-8B-Instruct.Q4_K_M.gguf")
        else:
            print("ggml-model-f16.gguf not found")
        print("\nğŸ“ Contents of current models directory:")
        print("\n".join(os.listdir(models_dir)))
        print("\nğŸ“ Contents of models_old directory:")
        print("\n".join(os.listdir(models_old_dir)))
        '
      - echo "âœ… Model renaming completed"

      - echo "ğŸš€ Uploading to Hugging Face..."
      - |
        python -c '
        import os
        from huggingface_hub import login, upload_folder
        try:
            token = os.environ.get("HF_TOKEN")
            if not token:
                raise ValueError("HF_TOKEN environment variable is not set")
            login(token=token)
            upload_folder(
                folder_path="models",
                path_in_repo="",
                repo_id="NickLamb/OpenROAD-8B-Instruct",
                repo_type="model"
            )
            print("âœ… Upload successful")
        except Exception as e:
            print(f"âŒ Error during upload: {str(e)}")
            exit(1)
        '
      - echo "ğŸ‰ Build process completed successfully"
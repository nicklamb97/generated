version: 0.2
env:
  variables:
    CUDA_HOME: "/usr/local/cuda"
    EFS_MOUNT_POINT: "/mnt/efs"
    MODEL_CACHE_PATH: "/mnt/efs/model_cache"

phases:
  install:
    runtime-versions:
      python: 3.10
    commands:
      - echo "üîß Updating system packages and installing CMake and NFS..."
      - apt-get update && apt-get install -y cmake nfs-common
      - echo "‚úÖ System packages updated and CMake installed"

      - echo "Mounting EFS..."
      - mkdir -p $EFS_MOUNT_POINT
      - mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2 ${EFS_DNS_NAME}:/ $EFS_MOUNT_POINT
      - echo "‚úÖ EFS mounted successfully"

  pre_build:
    commands:
      - echo "üîç Capturing triggering commit SHA..."
      - TRIGGER_COMMIT_SHA=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION)

  build:
    commands:
      - echo "üêç Installing Python dependencies..."
      - pip install --upgrade pip
      - echo "‚úÖ Pip upgraded successfully"

      - echo "üî• Installing PyTorch with CUDA support..."
      - pip uninstall -y torch
      - pip cache purge
      - pip install torch --index-url https://download.pytorch.org/whl/cu118
      - echo "‚úÖ PyTorch installed successfully"

      - echo "ü¶ô Installing llama-cpp-python with CUDA support..."
      - pip uninstall -y llama-cpp-python
      - pip cache remove llama_cpp_python
      - CMAKE_ARGS="-DLLAMA_CUBLAS=on" FORCE_CMAKE=1 pip install llama-cpp-python==0.2.75 --no-cache-dir
      - echo "‚úÖ llama-cpp-python installed successfully"

      - echo "ü§ó Installing huggingface_hub, transformers, bitsandbytes, peft, trl and accelerate..."
      - pip install huggingface_hub transformers
      - pip install bitsandbytes --prefer-binary
      - pip install accelerate peft trl
      - echo "‚úÖ huggingface_hub, transformers, bitsandbytes, and accelerate installed successfully"

      - echo "üîß Installing InstructLab..."
      - pip install instructlab --no-cache-dir
      - echo "‚úÖ InstructLab installed successfully"

      - echo "üìÇ Cloning repositories at specific commit..."
      - git clone https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/nicklamb97/generated.git
      - cd generated
      - git checkout $TRIGGER_COMMIT_SHA
      - cd ..
      - git clone https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/nicklamb97/instructlab-config.git
      - echo "‚úÖ Repositories cloned successfully"

      - echo "üìÑ Copying config file..."
      - cp instructlab-config/config.yaml .
      - echo "‚úÖ Config file copied successfully"

      - echo "üì• Checking for cached model..."
      - |
        mkdir -p $MODEL_CACHE_PATH
        if [ -f "$MODEL_CACHE_PATH/OpenROAD-8B-Instruct.Q4_K_M.gguf" ]; then
          echo "Using cached model..."
          cp $MODEL_CACHE_PATH/OpenROAD-8B-Instruct.Q4_K_M.gguf models/
        else
          echo "Downloading pre-trained model..."
          ilab model download --repository=diegesis/OpenROAD-8B-Instruct --filename=OpenROAD-8B-Instruct.Q4_K_M.gguf
          cp models/OpenROAD-8B-Instruct.Q4_K_M.gguf $MODEL_CACHE_PATH/
        fi
      - echo "‚úÖ Model ready for use"

      - echo "üèãÔ∏è Training model..."
      - ilab model train --device=cuda --num-epochs 24
      - echo "‚úÖ Model training completed"

      - echo "üìÅ Printing contents of models directory after training..."
      - ls -la models/
      - echo "‚úÖ Models directory contents printed"

      - echo "üè∑Ô∏è Renaming models..."
      - |
        python -c '
        import os
        from datetime import datetime
        import shutil
        current_time = datetime.now().strftime("%Y%m%d_%H%M%S")
        models_dir = "models"
        models_old_dir = "models_old"
        os.makedirs(models_old_dir, exist_ok=True)
        old_model_path = os.path.join(models_dir, "OpenROAD-8B-Instruct.Q4_K_M.gguf")
        if os.path.exists(old_model_path):
            old_model_name = f"openroad-model-{current_time}.gguf"
            shutil.move(old_model_path, os.path.join(models_old_dir, old_model_name))
            print(f"üì¶ Moved old OpenROAD-8B-Instruct.Q4_K_M.gguf to {models_old_dir}/{old_model_name}")
        else:
            print("No existing OpenROAD-8B-Instruct.Q4_K_M.gguf found")
        new_model_files = [f for f in os.listdir(models_dir) if f.startswith("ggml-model")]
        if new_model_files:
            new_model_path = os.path.join(models_dir, new_model_files[0])
            os.rename(new_model_path, os.path.join(models_dir, "OpenROAD-8B-Instruct.gguf"))
            print(f"‚úÖ Renamed {new_model_files[0]} to OpenROAD-8B-Instruct.gguf")
        else:
            print("No ggml-model file found")
        print("\nüìÅ Contents of current models directory:")
        print("\n".join(os.listdir(models_dir)))
        print("\nüìÅ Contents of models_old directory:")
        print("\n".join(os.listdir(models_old_dir)))
        '
      - echo "‚úÖ Model renaming completed"

      - echo "üî¢ Quantizing the trained model..."
      - pip install ctransformers
      - git clone https://github.com/ggerganov/llama.cpp
      - cd llama.cpp
      - make
      - ./llama-quantize ../models/OpenROAD-8B-Instruct.gguf ../models/OpenROAD-8B-Instruct.Q4_K_M.gguf q4_k_m
      - cd ..
      - echo "‚úÖ Model quantization completed"

      - echo "üóëÔ∏è Deleting unquantized model..."
      - |
        python -c '
        import os
        models_dir = "models"
        unquantized_model = "OpenROAD-8B-Instruct.gguf"
        if os.path.exists(os.path.join(models_dir, unquantized_model)):
            os.remove(os.path.join(models_dir, unquantized_model))
            print(f"üóëÔ∏è Deleted {unquantized_model} from {models_dir}")
        else:
            print(f"‚ùå {unquantized_model} not found in {models_dir}")
        print("\nüìÅ Updated contents of models directory:")
        print("\n".join(os.listdir(models_dir)))
        '
      - echo "‚úÖ Unquantized model deleted"

      - echo "üöÄ Uploading to Hugging Face..."
      - python upload_to_huggingface.py
      - |
        if [ $? -ne 0 ]; then
          echo "‚ùå Upload to Hugging Face failed. Skipping subsequent steps."
          exit 1
        fi
      - echo "üéâ Hugging Face upload completed successfully"

      - echo "üíæ Updating cached model..."
      - |
        if [ -f "$MODEL_CACHE_PATH/OpenROAD-8B-Instruct.Q4_K_M.gguf" ]; then
          echo "Removing old cached model..."
          rm "$MODEL_CACHE_PATH/OpenROAD-8B-Instruct.Q4_K_M.gguf"
        fi
        echo "Copying new model to cache..."
        cp models/OpenROAD-8B-Instruct.Q4_K_M.gguf $MODEL_CACHE_PATH/
        echo "‚úÖ Cached model updated successfully"

      - echo "üîç Moving recently added files to 'added' directory..."
      - |
        cd generated
        git diff-tree --no-commit-id --name-only -r $TRIGGER_COMMIT_SHA | while read -r file; do
          if [[ $file == discarded_* || $file == generated_* || $file == test_* || $file == train_* ]]; then
            if [ -f "$file" ]; then
              mv "$file" added/
              echo "Moved $file to added/"
            fi
          fi
        done
      - echo "‚úÖ Recently added files moved successfully"

      - echo "üîÑ Committing changes to generated repository..."
      - |
        cd generated
        git config user.name "Nick Lamb"
        git config user.email "nick.lamb@diegesis.co.uk"
        git add added/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Move recently added files to 'added' directory [skip ci]"
          git push https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/nicklamb97/generated.git HEAD:main
        fi
      - cd ..
      - echo "‚úÖ Changes committed and pushed to generated repository (if any)"

  post_build:
    commands:
      - echo "Unmounting EFS..."
      - umount $EFS_MOUNT_POINT
      - echo "‚úÖ EFS unmounted successfully"

      - echo "üéâ Build process completed successfully"
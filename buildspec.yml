version: 0.2
env:
  variables:
    CUDA_HOME: "/usr/local/cuda"
phases:
  install:
    runtime-versions:
      python: 3.10
    commands:
      - echo "ðŸ”§ Updating system packages and installing CMake..."
      - apt-get update && apt-get install -y cmake
      - echo "âœ… System packages updated and CMake installed"

  pre_build:
    commands:
      - echo "ðŸ” Capturing triggering commit SHA..."
      - TRIGGER_COMMIT_SHA=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION)

  build:
    commands:
      - echo "ðŸ Installing Python dependencies..."
      - pip install --upgrade pip
      - echo "âœ… Pip upgraded successfully"

      - echo "ðŸ”¥ Installing PyTorch with CUDA support..."
      - pip uninstall -y torch
      - pip cache purge
      - pip install torch --index-url https://download.pytorch.org/whl/cu118
      - echo "âœ… PyTorch installed successfully"

      - echo "ðŸ¦™ Installing llama-cpp-python with CUDA support..."
      - pip uninstall -y llama-cpp-python
      - pip cache remove llama_cpp_python
      - CMAKE_ARGS="-DLLAMA_CUBLAS=on" FORCE_CMAKE=1 pip install llama-cpp-python==0.2.75 --no-cache-dir
      - echo "âœ… llama-cpp-python installed successfully"

      - echo "ðŸ¤— Installing huggingface_hub, transformers, bitsandbytes, peft, trl and accelerate..."
      - pip install huggingface_hub transformers
      - pip install bitsandbytes --prefer-binary
      - pip install accelerate peft trl
      - echo "âœ… huggingface_hub, transformers, bitsandbytes, and accelerate installed successfully"

      - echo "ðŸ”§ Installing InstructLab..."
      - pip install instructlab --no-cache-dir
      - echo "âœ… InstructLab installed successfully"

      - echo "ðŸ“‚ Cloning repositories at specific commit..."
      - git clone https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/nicklamb97/generated.git
      - cd generated
      - git checkout $TRIGGER_COMMIT_SHA
      - cd ..
      - git clone https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/nicklamb97/instructlab-config.git
      - echo "âœ… Repositories cloned successfully"

      - echo "ðŸ“„ Copying config file..."
      - cp instructlab-config/config.yaml .
      - echo "âœ… Config file copied successfully"

      - echo "ðŸ“¥ Downloading pre-trained model..."
      - ilab model download --repository=diegesis/OpenROAD-8B-Instruct --filename=OpenROAD-8B-Instruct.gguf
      - echo "âœ… Pre-trained model downloaded successfully"

      - echo "ðŸ‹ï¸ Training model..."
      - ilab model train --device=cuda --num-epochs 10
      - echo "âœ… Model training completed"

      - echo "ðŸ“ Printing contents of models directory after training..."
      - ls -la models/
      - echo "âœ… Models directory contents printed"

      - echo "ðŸ·ï¸ Renaming models..."
      - |
        python -c '
        import os
        from datetime import datetime
        import shutil
        current_time = datetime.now().strftime("%Y%m%d_%H%M%S")
        models_dir = "models"
        models_old_dir = "models_old"
        os.makedirs(models_old_dir, exist_ok=True)
        old_model_path = os.path.join(models_dir, "OpenROAD-8B-Instruct.gguf")
        if os.path.exists(old_model_path):
            old_model_name = f"openroad-model-{current_time}.gguf"
            shutil.move(old_model_path, os.path.join(models_old_dir, old_model_name))
            print(f"ðŸ“¦ Moved old OpenROAD-8B-Instruct.gguf to {models_old_dir}/{old_model_name}")
        else:
            print("No existing OpenROAD-8B-Instruct.gguf found")
        new_model_files = [f for f in os.listdir(models_dir) if f.startswith("ggml-model")]
        if new_model_files:
            new_model_path = os.path.join(models_dir, new_model_files[0])
            os.rename(new_model_path, os.path.join(models_dir, "OpenROAD-8B-Instruct.gguf"))
            print(f"âœ… Renamed {new_model_files[0]} to OpenROAD-8B-Instruct.gguf")
        else:
            print("No ggml-model file found")
        print("\nðŸ“ Contents of current models directory:")
        print("\n".join(os.listdir(models_dir)))
        print("\nðŸ“ Contents of models_old directory:")
        print("\n".join(os.listdir(models_old_dir)))
        '
      - echo "âœ… Model renaming completed"

      - echo "ðŸš€ Uploading to Hugging Face..."
      - python upload_to_huggingface.py
      - |
        if [ $? -ne 0 ]; then
          echo "âŒ Upload to Hugging Face failed. Skipping subsequent steps."
          exit 1
        fi
      - echo "ðŸŽ‰ Hugging Face upload completed successfully"

      - echo "ðŸ” Moving files to 'trained' directory..."
      - |
        mkdir -p generated/trained
        mv generated/{generated_*,discarded_*,test_*,train_*} generated/trained/ 2>/dev/null || true
      - echo "âœ… Files moved to 'trained' directory successfully"

      - echo "ðŸ”„ Committing changes to generated repository..."
      - |
        cd generated
        git config user.name "Nick Lamb"
        git config user.email "nick.lamb@diegesis.co.uk"
        git add trained/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Move files to 'trained' directory [skip ci]"
          git push https://${GITHUB_USERNAME}:${GITHUB_TOKEN}@github.com/nicklamb97/generated.git HEAD:main
        fi
      - cd ..
      - echo "âœ… Changes committed and pushed to generated repository (if any)"

      - echo "ðŸŽ‰ Build process completed successfully"